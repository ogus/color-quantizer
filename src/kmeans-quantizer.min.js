!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.KMeansQuantizer=t()}("undefined"!=typeof self?self:this,function(){"use strict";function e(e,t,n){this.red=e,this.green=t,this.blue=n}function t(e,t){let n=.5*(e.red+t.red),r=e.red-t.red,l=e.green-t.green,o=e.blue-t.blue,u=2*r*r+4*l*l+3*o*o+n*(r*r-o*o)/256;return Math.sqrt(u)/765}function n(e,n){let r=4095,l=0,o=0;for(let u=0;u<n.length;u++)(l=t(e,n[u]))<r&&(r=l,o=u);return o}function r(t,n){return new e(t[n],t[n+1],t[n+2])}function l(e,t,n){e[t]=n.red,e[t+1]=n.green,e[t+2]=n.blue,e[t+3]=255}function o(e){return r(e,Math.floor(Math.random()*(e.length>>2))<<2)}function u(t){let n=0,r=0,l=0,o=t.length;for(let e=0;e<o;e++)n+=t[e].red,r+=t[e].green,l+=t[e].blue;return new e(n/=o,r/=o,l/=o)}function i(e){let n=e.length,r=u(e),l=0,o=0;for(let u=0;u<n;u++)o+=(l=t(e[u],r))*l;return o/n}function f(e){let t=new Array(e);for(let e=0;e<t.length;e++)t[e]=[];return t}function a(e,t){let n=new Array(t.length);for(let r=0;r<n.length;r++)t[r].length>0?n[r]=u(t[r]):n[r]=o(e);return n}function s(t,o){let u=parseInt(o.k),s=function(t,l){let o=f(l),u=new Array(l),s=new Array(t.length>>2).fill(-1),c=new e(0,0,0),d=0,g=new Array(l).fill(1),h=0,m=0,p=0;for(;;){u=a(t,o),o=f(l);for(let e=0;e<t.length;e+=4)c=r(t,e),s[e>>2]=n(c,u),o[s[e>>2]].push(c);p=0;for(let e=0;e<o.length;e++)h=i(o[e]),m=Math.abs(g[e]-h),p=Math.max(m,p),g[e]=h;if(p<1e-4||d++>20)break}return{centroidList:u,clusterList:o,assignement:s}}(t.data,u);return{imageData:function(e,t){let n=new Uint8ClampedArray(e.length),r=t.centroidList,o=t.assignement;for(let e=0;e<n.length;e+=4)l(n,e,r[o[e>>2]]);return n}(t.data,s),palette:s.centroidList}}return"undefined"!=typeof self&&(self.onmessage=function(e){let t=e.data.imageData,n=e.data.params;if(t&&n){let e=s(t,n);postMessage(e)}else postMessage(null)}),{compute:function(e,t){return t.async?new Promise(function(n,r){n(s(e,t))}):s(e,t)}}});
