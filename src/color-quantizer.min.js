!function(e,n){"function"==typeof define&&define.amd?define([],n):"object"==typeof module&&module.exports?module.exports=n():e.ColorQuantizer=n()}("undefined"!=typeof self?self:this,function(){"use strict";function e(e,n){let t=.5*(e.r+n.r),r=e.r-n.r,l=e.g-n.g,o=e.b-n.b;return Math.sqrt(2*r*r+4*l*l+3*o*o+t*(r*r-o*o)/256)}function n(n,t){let r=65535,l=0,o=0;for(let i=0;i<t.length;i++)(l=e(n,t[i]))<r&&(r=l,o=i);return o}function t(n,t){let r=0,l=256,o=0,i=0;for(let a=0;a<n.length;a++)i=e(n[a],t[a]),r=Math.max(r,i),l=Math.min(l,i),o+=i;return{max:r,min:l,mean:o/=n.length}}function r(e){let n=Math.floor(Math.random()*(e.length>>2))<<2;return{r:e[n],g:e[n+1],b:e[n+2]}}function l(e){let n=0,t=0,r=0;for(let l=0;l<e.length;l++)n+=e[l].r,t+=e[l].g,r+=e[l].b;return n/=e.length,t/=e.length,r/=e.length,isNaN(n)||isNaN(t)||isNaN(r)?null:{r:n,g:t,b:r}}function o(e,t){let o=0,i=new Array(t.length);for(o=0;o<i.length;o++)i[o]=[];let a=new Array(e.length>>2);for(o=0;o<a.length;o++)a[o]=-1;let f=0,u={};for(o=0;o<e.length;o+=4)i[f=n(u={r:e[o],g:e[o+1],b:e[o+2]},t)].push(u),a[o>>2]=f;let g=new Array(t.length);for(o=0;o<g.length;o++)g[o]=l(i[o]),null==g[o]&&(g[o]=r(e));return{assigned:a,centroids:g}}function i(e,n){let l=function(e,n){let l=new Array(n);for(let n=0;n<l.length;n++)l[n]=r(e);let i=0,a=!0,f={},u=null,g=null;for(;a;){i++,l=(f=o(e,l)).centroids,null!==u?a=(g=t(u,l)).max>5||g.min>.5:u=new Array(l.length);for(let e=0;e<l.length;e++)u[e]=Object.assign({},l[e]);if(i>50){console.log("Too much iteration: quantization stopped to avoid freezing");break}}return f}(e,n),i=new Uint8ClampedArray(e.length),a={};for(let e=0;e<i.length;e+=4)a=l.centroids[l.assigned[e>>2]],i[e]=a.r,i[e+1]=a.g,i[e+2]=a.b,i[e+3]=255;return i}function a(e,t){let r=0,l=new Uint8ClampedArray(e.length);for(let o=0;o<e.length;o+=4)r=n({r:e[o],g:e[o+1],b:e[o+2]},t),l[o]=t[r].r,l[o+1]=t[r].g,l[o+2]=t[r].b,l[o+3]=255;return l}function f(e,n){let t=n||{};if(t.colors&&Array.isArray(t.colors)){for(let e=0;e<t.colors.length;e++)if(!t.colors[e].r||!t.colors[e].g||!t.colors[e].b)return null;return new Promise(function(n,r){n(a(e.data,t.colors))})}{let n=e.data,r=t.k||3;return t.grayscale&&(n=function(e){let n=new Uint8ClampedArray(e.length),t=0,r=0,l=0;for(let o=0;o<e.length;o+=4)t=e[o],r=e[o+1],l=e[o+2],n[o]=n[o+1]=n[o+2]=.2126*t+.7152*r+.0722*l;return n}(n)),new Promise(function(e,t){e(i(n,r))})}}var ColorQuantizer={compute:f,quantize:i,applyColor:a};return"undefined"!=typeof self&&(self.onmessage=function(e){f(e.data.img,e.data.config).then(function(e){postMessage(e)})}),ColorQuantizer});
